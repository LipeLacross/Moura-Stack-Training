{% extends "base.html" %}
{% block title %}Dashboard Moura Stack{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<!-- Guia rápido para o avaliador -->
<div class="mb-10 p-6 bg-card border border-border rounded-lg shadow flex flex-col md:flex-row gap-6 items-center">
  <div class="flex-1">
    <h2 class="text-2xl font-bold text-primary mb-2">Bem-vindo ao Moura Stack 🚀</h2>
    <p class="text-kpi mb-2">Este dashboard demonstra um projeto completo de Data Stack para análise de vendas, automação de ETL, machine learning, exportação de dados e integração com BI.</p>
    <ul class="list-disc pl-6 text-kpi text-sm mb-2">
      <li>KPIs e gráficos interativos</li>
      <li>API REST com endpoints GET/POST</li>
      <li>ETL Prefect, PySpark, dbt, Export Excel</li>
      <li>Infraestrutura Docker pronta para produção</li>
    </ul>
    <a href="/docs" target="_blank" class="inline-block mt-2 px-4 py-2 bg-primary text-white rounded shadow hover:bg-blue-700 font-bold">Abrir documentação Swagger/OpenAPI</a>
  </div>
  <div class="flex flex-col gap-2 items-center">
    <span class="text-4xl">🔋</span>
    <span class="text-xs text-gray-400">Powered by Moura</span>
  </div>
</div>

<!-- Filtros -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Filtros</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Data Inicial</label>
      <input type="date" id="start-date" class="w-full p-2 border border-border rounded">
    </div>
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Data Final</label>
      <input type="date" id="end-date" class="w-full p-2 border border-border rounded">
    </div>
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Produto</label>
      <select id="product-filter" class="w-full p-2 border border-border rounded">
        <option value="">Todos os Produtos</option>
        {% for product in products %}
        <option value="{{ product }}">{{ product }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex items-end">
      <button id="apply-filters" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-blue-700">
        Aplicar Filtros
      </button>
    </div>
  </div>
</div>

<!-- KPIs -->
<div class="mb-8">
  <h2 class="text-2xl font-bold mb-4 text-primary">Resumo de Vendas</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10" id="kpi-container">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center relative" id="revenue-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">💰</span>
        <span class="uppercase text-sm text-kpi">Receita Total</span>
      </div>
      <div class="text-2xl font-bold text-primary">R$ {{ summary.total_revenue | round(2) }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">→</span> <span class="trend-value">0%</span>
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center" id="quantity-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">📦</span>
        <span class="uppercase text-sm text-kpi">Quantidade Total</span>
      </div>
      <div class="text-2xl font-bold text-primary">{{ summary.total_quantity }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">→</span> <span class="trend-value">0%</span>
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center" id="avg-ticket-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">🎫</span>
        <span class="uppercase text-sm text-kpi">Ticket Médio</span>
      </div>
      <div class="text-2xl font-bold text-primary">R$ {{ summary.avg_ticket | round(2) }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">→</span> <span class="trend-value">0%</span>
      </div>
    </div>
  </div>
</div>

<!-- Preview de vendas -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Preview de Vendas (API)</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    <pre class="text-xs text-kpi" id="sales-preview"></pre>
    <div class="text-xs text-gray-400 mt-2">Endpoint: <a href="/metrics/sales" class="text-primary underline">/metrics/sales</a></div>
  </div>
</div>

<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-primary">Receita por Período</h2>
      <div class="flex space-x-2">
        <button class="time-filter-btn px-3 py-1 rounded border border-border bg-white text-sm" data-period="week">Semana</button>
        <button class="time-filter-btn px-3 py-1 rounded border border-border bg-primary text-white text-sm" data-period="month">Mês</button>
        <button class="time-filter-btn px-3 py-1 rounded border border-border bg-white text-sm" data-period="year">Ano</button>
      </div>
    </div>
    <div class="h-80">
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Distribuição por Categoria</h2>
    <div class="h-80">
      <canvas id="categoryChart"></canvas>
    </div>
  </div>
</div>

<!-- Tabela de Vendas -->
<div class="bg-card border border-border rounded-lg shadow overflow-hidden mb-8">
  <div class="p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-primary">Últimas Vendas</h2>
      <div class="relative">
        <input type="text" id="search-sales" placeholder="Buscar vendas..." class="pl-8 pr-4 py-2 border border-border rounded-lg">
        <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="sales-table">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="date">
              Data
              <span class="sort-indicator">↓</span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="product">
              Produto
              <span class="sort-indicator"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="quantity">
              Quantidade
              <span class="sort-indicator"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="price">
              Preço Unit.
              <span class="sort-indicator"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="total">
              Total
              <span class="sort-indicator"></span>
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="sales-table-body">
          {% for sale in sales %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ sale.date }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ sale.product }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ sale.quantity }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {{ "%.2f"|format(sale.unit_price) }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">R$ {{ "%.2f"|format(sale.total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4">
      <div class="flex flex-1 justify-between sm:hidden">
        <button class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" id="prev-page-mobile">Anterior</button>
        <button class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" id="next-page-mobile">Próximo</button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Mostrando <span class="font-medium" id="start-item">1</span> a <span class="font-medium" id="end-item">10</span> de <span class="font-medium" id="total-items">{{ sales|length }}</span> resultados
          </p>
        </div>
        <div>
          <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <button class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" id="prev-page">
              <span class="sr-only">Anterior</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="pagination-numbers" class="flex">
              <!-- Pagination numbers will be inserted here by JavaScript -->
            </div>
            <button class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" id="next-page">
              <span class="sr-only">Próximo</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Power BI -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Embed Power BI</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    {% if power_bi_url %}
      <iframe src="{{ power_bi_url }}" height="800" class="w-full rounded-lg border border-border transition-shadow duration-300 hover:shadow-lg"></iframe>
    {% else %}
      <div class="text-kpi">Power BI não configurado.</div>
    {% endif %}
  </div>
</div>

<!-- Endpoints REST -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Testar Endpoints POST (interativo)</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-4">
      <h3 class="font-bold text-primary mb-2">ML Train</h3>
      <button id="ml-train-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700">Treinar modelo</button>
      <pre id="ml-train-resp" class="bg-gray-100 rounded p-2 text-xs mt-2"></pre>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-4">
      <h3 class="font-bold text-primary mb-2">ML Predict</h3>
      <form id="ml-predict-form" class="flex flex-col gap-2">
        <input type="number" name="quantity" min="1" placeholder="Quantidade" class="border border-border rounded px-2 py-1" required />
        <input type="number" name="unit_price" min="1" step="any" placeholder="Preço unitário" class="border border-border rounded px-2 py-1" required />
        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700">Prever</button>
      </form>
      <pre id="ml-predict-resp" class="bg-gray-100 rounded p-2 text-xs mt-2"></pre>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-4">
      <h3 class="font-bold text-primary mb-2">ETL Run</h3>
      <button id="etl-run-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700">Executar ETL</button>
      <pre id="etl-run-resp" class="bg-gray-100 rounded p-2 text-xs mt-2"></pre>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-4">
      <h3 class="font-bold text-primary mb-2">Gold Export</h3>
      <button id="gold-export-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700">Exportar Gold</button>
      <pre id="gold-export-resp" class="bg-gray-100 rounded p-2 text-xs mt-2"></pre>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-4">
      <h3 class="font-bold text-primary mb-2">Spark Run</h3>
      <button id="spark-run-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700">Executar Spark</button>
      <pre id="spark-run-resp" class="bg-gray-100 rounded p-2 text-xs mt-2"></pre>
    </div>
  </div>
</div>

<!-- Endpoints REST (GET/POST) -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Exemplos de API REST</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    <div class="mb-2 text-sm text-gray-700">Endpoints <b>GET</b> funcionam direto no navegador. Endpoints <b>POST</b> devem ser chamados via <b>curl</b> ou <b>fetch</b> (botão copiar disponível).</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-bold text-primary mb-2">GET</h3>
        <ul class="list-disc pl-6 text-kpi">
          <li><a href="/health" class="text-primary underline">/health</a> — Status da API e banco</li>
          <li><a href="/metrics/sales" class="text-primary underline">/metrics/sales</a> — Preview de vendas</li>
          <li><a href="/metrics/summary" class="text-primary underline">/metrics/summary</a> — KPIs agregados</li>
          <li><a href="/stats/pearson" class="text-primary underline">/stats/pearson</a> — Correlação Pearson</li>
          <li><a href="/stats/ols" class="text-primary underline">/stats/ols</a> — Regressão OLS</li>
          <li><a href="/export/excel" class="text-primary underline">/export/excel</a> — Exportar Excel</li>
        </ul>
      </div>
      <div>
        <h3 class="font-bold text-primary mb-2">POST</h3>
        <ul class="list-disc pl-6 text-kpi">
          <li>Treinar modelo ML <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /ml/train">Copiar curl</button>)</span></li>
          <li>Predição ML <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST -H 'Content-Type: application/json' -d '{\"quantity\":10,\"unit_price\":200}' /ml/predict">Copiar curl</button>)</span></li>
          <li>Executar ETL Prefect <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /etl/run">Copiar curl</button>)</span></li>
          <li>Exportar Gold Parquet/CSV <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /gold/export">Copiar curl</button>)</span></li>
          <li>Job PySpark <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /spark/run">Copiar curl</button>)</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Stack cards -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Infraestrutura & Data Stack</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">🗄️</span><span class="font-bold">PostgreSQL</span></div>
      <div class="text-sm text-kpi">Tabela <code>sales</code>, trigger <code>set_total</code>, procedure <code>upsert_product_revenue</code>.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">⚡</span><span class="font-bold">ETL Prefect</span></div>
      <div class="text-sm text-kpi">Fluxo para gerar Parquet/CSV (camada Gold).</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">🔥</span><span class="font-bold">PySpark</span></div>
      <div class="text-sm text-kpi">Job para processamento em larga escala.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">📊</span><span class="font-bold">Export Excel</span></div>
      <div class="text-sm text-kpi">Endpoint usando OpenPyXL.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">🧬</span><span class="font-bold">dbt</span></div>
      <div class="text-sm text-kpi">Modelos <code>stg_sales</code> (silver) e <code>fct_sales</code> (gold).</div>
      <div class="mt-2 text-xs text-gray-700">Exemplo de modelo SQL (fct_sales.sql):</div>
      <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">select
  product,
  sum(quantity)    as total_quantity,
  sum(total)       as total_revenue,
  avg(unit_price)  as avg_unit_price
from {{ ref('stg_sales') }}
group by product;</pre>
      <div class="mt-2 text-xs text-gray-700">O dbt permite modelar dados analíticos em camadas (silver/gold), facilitando análises e integrações BI. <a href="https://docs.getdbt.com/docs/building-a-dbt-project" target="_blank" class="text-primary underline">Saiba mais</a></div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">🐳</span><span class="font-bold">Docker</span></div>
      <div class="text-sm text-kpi">Dockerfile e docker-compose prontos para uso e deploy.</div>
    </div>
  </div>
</div>

<script>
  // Dados iniciais
  const salesData = {{ sales|tojson|safe }};
  const products = {{ products|tojson|safe }};
  
  // Configuração da paginação
  let currentPage = 1;
  const rowsPerPage = 10;
  let currentSort = { column: 'date', direction: 'desc' };
  let filteredData = [...salesData];
  
  // Inicialização
  document.addEventListener('DOMContentLoaded', function() {
    // Inicializa os gráficos
    initCharts();
    
    // Configura os filtros
    setupFilters();
    
    // Configura a ordenação da tabela
    setupSorting();
    
    // Configura a paginação
    setupPagination();
    
    // Configura a busca
    document.getElementById('search-sales').addEventListener('input', filterTable);
    
    // Configura os botões de período
    document.querySelectorAll('.time-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('bg-primary', 'text-white'));
        this.classList.add('bg-primary', 'text-white');
        updateCharts(this.dataset.period);
      });
    });
    
    // Inicializa a tabela
    updateTable();
  });
  
  // Inicializa os gráficos
  function initCharts() {
    // Gráfico de receita
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    window.revenueChart = new Chart(revenueCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Receita (R$)',
          data: [],
          borderColor: 'rgb(59, 130, 246)',
          tension: 0.3,
          fill: true,
          backgroundColor: 'rgba(59, 130, 246, 0.1)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false,
          },
          legend: {
            position: 'top',
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
    
    // Gráfico de categorias
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    window.categoryChart = new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: [
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(239, 68, 68, 0.8)',
            'rgba(139, 92, 246, 0.8)'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: R$ ${value.toLocaleString()} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    
    // Atualiza os gráficos com os dados iniciais
    updateCharts('month');
  }
  
  // Atualiza os gráficos com base no período selecionado
  function updateCharts(period) {
    // Simula dados para o exemplo
    const now = new Date();
    let labels = [];
    let revenueData = [];
    
    if (period === 'week') {
      // Últimos 7 dias
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(now.getDate() - i);
        labels.push(date.toLocaleDateString('pt-BR', { weekday: 'short' }));
        revenueData.push(Math.floor(Math.random() * 10000) + 5000);
      }
    } else if (period === 'month') {
      // Últimos 30 dias
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(now.getDate() - i);
        if (i % 5 === 0) {
          labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit' }));
        } else {
          labels.push('');
        }
        revenueData.push(Math.floor(Math.random() * 5000) + 2000);
      }
    } else {
      // Últimos 12 meses
      for (let i = 11; i >= 0; i--) {
        const date = new Date();
        date.setMonth(now.getMonth() - i);
        labels.push(date.toLocaleDateString('pt-BR', { month: 'short' }));
        revenueData.push(Math.floor(Math.random() * 15000) + 10000);
      }
    }
    
    // Atualiza o gráfico de receita
    window.revenueChart.data.labels = labels;
    window.revenueChart.data.datasets[0].data = revenueData;
    window.revenueChart.update();
    
    // Atualiza o gráfico de categorias (dados de exemplo)
    const categories = ['Baterias', 'Autopeças', 'Serviços', 'Acessórios', 'Outros'];
    const categoryData = categories.map(() => Math.floor(Math.random() * 10000) + 2000);
    
    window.categoryChart.data.labels = categories;
    window.categoryChart.data.datasets[0].data = categoryData;
    window.categoryChart.update();
    
    // Atualiza os KPIs
    updateKPIs(revenueData, categoryData);
  }
  
  // Atualiza os KPIs com base nos dados dos gráficos
  function updateKPIs(revenueData, categoryData) {
    const totalRevenue = revenueData.reduce((a, b) => a + b, 0);
    const totalQuantity = Math.floor(totalRevenue / 100);
    const avgTicket = totalRevenue / (totalQuantity || 1);
    
    // Atualiza os valores
    document.querySelector('#revenue-kpi .text-2xl').textContent = `R$ ${totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.querySelector('#quantity-kpi .text-2xl').textContent = totalQuantity.toLocaleString('pt-BR');
    document.querySelector('#avg-ticket-kpi .text-2xl').textContent = `R$ ${avgTicket.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    
    // Atualiza as tendências (exemplo aleatório)
    const trends = document.querySelectorAll('.trend-value');
    trends.forEach(trend => {
      const change = (Math.random() * 20 - 5).toFixed(1);
      const isPositive = change >= 0;
      const arrow = trend.previousElementSibling;
      
      trend.textContent = `${Math.abs(change)}%`;
      trend.className = `trend-value text-xs mt-1 ${isPositive ? 'text-green-500' : 'text-red-500'}`;
      arrow.textContent = isPositive ? '↑' : '↓';
      arrow.className = `trend-arrow ${isPositive ? 'text-green-500' : 'text-red-500'}`;
    });
  }
  
  // Configura os filtros
  function setupFilters() {
    // Define as datas padrão (últimos 30 dias)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 30);
    
    // Formata as datas para o input date (YYYY-MM-DD)
    document.getElementById('start-date').valueAsDate = startDate;
    document.getElementById('end-date').valueAsDate = endDate;
    
    // Adiciona o evento de clique no botão de aplicar filtros
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
  }
  
  // Aplica os filtros
  function applyFilters() {
    const startDate = new Date(document.getElementById('start-date').value);
    const endDate = new Date(document.getElementById('end-date').value);
    const productFilter = document.getElementById('product-filter').value;
    
    // Filtra os dados
    filteredData = salesData.filter(sale => {
      const saleDate = new Date(sale.date);
      const matchesDate = (!startDate || saleDate >= startDate) && 
                         (!endDate || saleDate <= endDate);
      const matchesProduct = !productFilter || sale.product === productFilter;
      
      return matchesDate && matchesProduct;
    });
    
    // Atualiza a tabela e a paginação
    currentPage = 1;
    updateTable();
    updatePagination();
    
    // Atualiza os gráficos (simulação)
    updateCharts('month');
  }
  
  // Configura a ordenação da tabela
  function setupSorting() {
    document.querySelectorAll('.sortable').forEach(header => {
      header.addEventListener('click', () => {
        const column = header.dataset.sort;
        const isCurrentColumn = currentSort.column === column;
        
        // Alterna a direção se for a mesma coluna
        currentSort = {
          column,
          direction: isCurrentColumn && currentSort.direction === 'asc' ? 'desc' : 'asc'
        };
        
        // Atualiza os indicadores visuais
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
          indicator.textContent = '';
        });
        
        const indicator = header.querySelector('.sort-indicator');
        indicator.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
        
        // Ordena os dados
        sortData();
        updateTable();
      });
    });
  }
  
  // Ordena os dados com base na coluna e direção atuais
  function sortData() {
    filteredData.sort((a, b) => {
      let valueA, valueB;
      
      switch(currentSort.column) {
        case 'date':
          valueA = new Date(a.date);
          valueB = new Date(b.date);
          break;
        case 'product':
          valueA = a.product.toLowerCase();
          valueB = b.product.toLowerCase();
          break;
        case 'quantity':
          valueA = parseFloat(a.quantity);
          valueB = parseFloat(b.quantity);
          break;
        case 'price':
          valueA = parseFloat(a.unit_price);
          valueB = parseFloat(b.unit_price);
          break;
        case 'total':
          valueA = parseFloat(a.total);
          valueB = parseFloat(b.total);
          break;
        default:
          valueA = a[0];
          valueB = b[0];
      }
      
      if (valueA < valueB) {
        return currentSort.direction === 'asc' ? -1 : 1;
      }
      if (valueA > valueB) {
        return currentSort.direction === 'asc' ? 1 : -1;
      }
      return 0;
    });
  }
  
  // Configura a paginação
  function setupPagination() {
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updateTable();
        updatePagination();
      }
    });
    
    document.getElementById('next-page').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updateTable();
        updatePagination();
      }
    });
    
    // Versão mobile
    document.getElementById('prev-page-mobile').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updateTable();
        updatePagination();
      }
    });
    
    document.getElementById('next-page-mobile').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updateTable();
        updatePagination();
      }
    });
    
    updatePagination();
  }
  
  // Atualiza a exibição da paginação
  function updatePagination() {
    const totalItems = filteredData.length;
    const totalPages = Math.ceil(totalItems / rowsPerPage);
    
    // Atualiza os contadores
    const startItem = (currentPage - 1) * rowsPerPage + 1;
    const endItem = Math.min(startItem + rowsPerPage - 1, totalItems);
    
    document.getElementById('start-item').textContent = startItem;
    document.getElementById('end-item').textContent = endItem;
    document.getElementById('total-items').textContent = totalItems;
    
    // Atualiza os botões de navegação
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages;
    document.getElementById('prev-page-mobile').disabled = currentPage === 1;
    document.getElementById('next-page-mobile').disabled = currentPage === totalPages;
    
    // Atualiza os números da paginação
    const paginationContainer = document.getElementById('pagination-numbers');
    paginationContainer.innerHTML = '';
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Botão primeira página
    if (startPage > 1) {
      const firstPageBtn = document.createElement('button');
      firstPageBtn.textContent = '1';
      firstPageBtn.className = 'relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0';
      firstPageBtn.addEventListener('click', () => {
        currentPage = 1;
        updateTable();
        updatePagination();
      });
      paginationContainer.appendChild(firstPageBtn);
      
      if (startPage > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700';
        ellipsis.textContent = '...';
        paginationContainer.appendChild(ellipsis);
      }
    }
    
    // Botões das páginas
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = i;
      pageBtn.className = `relative inline-flex items-center px-4 py-2 text-sm font-semibold ${i === currentPage ? 'z-10 bg-primary text-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary' : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`;
      
      if (i !== currentPage) {
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          updateTable();
          updatePagination();
        });
      }
      
      paginationContainer.appendChild(pageBtn);
    }
    
    // Botão última página
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700';
        ellipsis.textContent = '...';
        paginationContainer.appendChild(ellipsis);
      }
      
      const lastPageBtn = document.createElement('button');
      lastPageBtn.textContent = totalPages;
      lastPageBtn.className = 'relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0';
      lastPageBtn.addEventListener('click', () => {
        currentPage = totalPages;
        updateTable();
        updatePagination();
      });
      paginationContainer.appendChild(lastPageBtn);
    }
  }
  
  // Filtra a tabela com base no texto de busca
  function filterTable() {
    const searchText = document.getElementById('search-sales').value.toLowerCase();
    
    if (!searchText) {
      filteredData = [...salesData];
    } else {
      filteredData = salesData.filter(sale => 
        sale.product.toLowerCase().includes(searchText) ||
        sale.date.includes(searchText) ||
        sale.quantity.toString().includes(searchText) ||
        sale.unit_price.toString().includes(searchText) ||
        sale.total.toString().includes(searchText)
      );
    }
    
    currentPage = 1;
    updateTable();
    updatePagination();
  }
  
  // Atualiza a tabela com os dados atuais
  function updateTable() {
    const tbody = document.getElementById('sales-table-body');
    tbody.innerHTML = '';
    
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = filteredData.slice(start, end);
    
    if (paginatedData.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">
          Nenhum dado encontrado com os filtros atuais.
        </td>
      `;
      tbody.appendChild(tr);
      return;
    }
    
    paginatedData.forEach(sale => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50';
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.date}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.product}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.quantity}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${parseFloat(sale.unit_price).toFixed(2)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">R$ ${parseFloat(sale.total).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  // Animação de fade-in para os cards
  document.querySelectorAll('.bg-card').forEach(function(card, i) {
    card.style.opacity = 0;
    setTimeout(function() {
      card.style.transition = 'opacity 0.7s';
      card.style.opacity = 1;
    }, 200 + i * 150);
  });
  
  // Formatador JSON para preview de vendas
  const preview = {{ sales_preview|tojson|safe }};
    const el = document.getElementById('sales-preview');
    if (el && preview) {
      el.textContent = JSON.stringify(preview, null, 2);
    }

    // Botão copiar curl
    document.querySelectorAll('.copy-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        navigator.clipboard.writeText(btn.getAttribute('data-cmd'));
        btn.textContent = 'Copiado!';
        setTimeout(function() { btn.textContent = 'Copiar curl'; }, 1200);
      });
    });
  });

  // Forms interativos para endpoints POST
  function showResp(id, data) {
    document.getElementById(id).textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
  }
  document.getElementById('ml-train-btn').onclick = async function() {
    showResp('ml-train-resp', 'Processando...');
    const resp = await fetch('/ml/train', {method: 'POST'});
    showResp('ml-train-resp', await resp.json());
  };
  document.getElementById('ml-predict-form').onsubmit = async function(e) {
    e.preventDefault();
    showResp('ml-predict-resp', 'Processando...');
    const quantity = this.quantity.value;
    const unit_price = this.unit_price.value;
    const resp = await fetch('/ml/predict', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({quantity: Number(quantity), unit_price: Number(unit_price)})
    });
    showResp('ml-predict-resp', await resp.json());
  };
  document.getElementById('etl-run-btn').onclick = async function() {
    showResp('etl-run-resp', 'Processando...');
    const resp = await fetch('/etl/run', {method: 'POST'});
    showResp('etl-run-resp', await resp.json());
  };
  document.getElementById('gold-export-btn').onclick = async function() {
    showResp('gold-export-resp', 'Processando...');
    const resp = await fetch('/gold/export', {method: 'POST'});
    showResp('gold-export-resp', await resp.json());
  };
  document.getElementById('spark-run-btn').onclick = async function() {
    showResp('spark-run-resp', 'Processando...');
    const resp = await fetch('/spark/run', {method: 'POST'});
    showResp('spark-run-resp', await resp.json());
  };
</script>
{% endblock %}
