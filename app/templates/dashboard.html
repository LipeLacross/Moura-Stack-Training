{% extends "base.html" %}
{% block title %}Dashboard Moura Stack{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  .chart-container { position: relative; height: 320px; }
</style>
{% endblock %}

{% block content %}
<link rel="icon" type="image/x-icon" href="/public/moura-logo.ico">

<!-- Guia r√°pido para o avaliador -->
<div class="mb-10 p-6 bg-card border border-border rounded-lg shadow flex flex-col md:flex-row gap-6 items-center">
  <div class="flex-1">
    <h2 class="text-2xl font-bold text-primary mb-2">Bem-vindo ao Moura Stack üöÄ</h2>
    <p class="text-kpi mb-2">Este dashboard demonstra um projeto completo de Data Stack para an√°lise de vendas, automa√ß√£o de ETL, machine learning, exporta√ß√£o de dados e integra√ß√£o com BI.</p>
    <ul class="list-disc pl-6 text-kpi text-sm mb-2">
      <li>KPIs e gr√°ficos interativos</li>
      <li>API REST com endpoints GET/POST</li>
      <li>ETL Prefect, PySpark, dbt, Export Excel</li>
      <li>Infraestrutura Docker pronta para produ√ß√£o</li>
    </ul>
    <a href="/docs" target="_blank" class="inline-block mt-2 px-4 py-2 bg-primary text-white rounded shadow hover:bg-blue-700 font-bold">Abrir documenta√ß√£o Swagger/OpenAPI</a>
  </div>
</div>

<!-- Filtros -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Filtros <span title="Filtros permitem selecionar datas e produtos para refinar os dados exibidos." style="cursor:help;">‚ÑπÔ∏è</span></h2>
  <p class="text-xs text-gray-600 mb-2">Utilize os filtros abaixo para refinar os dados exibidos nos KPIs, gr√°ficos e tabelas conforme per√≠odo e produto desejado.</p>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Data Inicial</label>
      <input type="date" id="start-date" class="w-full p-2 border border-border rounded">
    </div>
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Data Final</label>
      <input type="date" id="end-date" class="w-full p-2 border border-border rounded">
    </div>
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Produto</label>
      <select id="product-filter" class="w-full p-2 border border-border rounded">
        <option value="">Todos os Produtos</option>
        {% for product in products %}
        <option value="{{ product }}">{{ product }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex items-end">
      <button id="apply-filters" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-blue-700">
        Aplicar Filtros
      </button>
    </div>
  </div>
</div>

<!-- KPIs -->
<div class="mb-8">
  <h2 class="text-2xl font-bold mb-4 text-primary">Resumo de Vendas <span title="KPIs s√£o indicadores-chave de desempenho, como receita, quantidade e ticket m√©dio." style="cursor:help;">‚ÑπÔ∏è</span></h2>
  <p class="text-xs text-gray-600 mb-2">KPIs mostram m√©tricas agregadas do per√≠odo selecionado: receita total, quantidade vendida e ticket m√©dio.</p>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10" id="kpi-container">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center relative" id="revenue-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">üí∞</span>
        <span class="uppercase text-sm text-kpi">Receita Total</span>
      </div>
      <div class="text-2xl font-bold text-primary">R$ {{ summary.total_revenue | round(2) }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">‚Üí</span> <span class="trend-value">0%</span>
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center" id="quantity-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">üì¶</span>
        <span class="uppercase text-sm text-kpi">Quantidade Total</span>
      </div>
      <div class="text-2xl font-bold text-primary">{{ summary.total_quantity }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">‚Üí</span> <span class="trend-value">0%</span>
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center" id="avg-ticket-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">üé´</span>
        <span class="uppercase text-sm text-kpi">Ticket M√©dio</span>
      </div>
      <div class="text-2xl font-bold text-primary">R$ {{ summary.avg_ticket | round(2) }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">‚Üí</span> <span class="trend-value">0%</span>
      </div>
    </div>
  </div>
</div>

<!-- Preview de vendas -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Preview de Vendas (API) <span title="API REST permite acessar dados via endpoints, como /metrics/sales." style="cursor:help;">‚ÑπÔ∏è</span></h2>
  <p class="text-xs text-gray-600 mb-2">Os dados exibidos abaixo s√£o provenientes de um <b>banco de dados PostgreSQL</b> hospedado na <b>Lacrosstech</b>. Para visualizar, buscar e filtrar vendas, utilize a tabela detalhada abaixo.</p>
  <div class="bg-card rounded-lg p-4 mb-4">
    <div class="text-xs text-kpi">A tabela detalhada de vendas permite navega√ß√£o, busca e filtros avan√ßados diretamente nos dados reais do banco.</div>
    <div class="text-xs text-gray-400 mt-2">Endpoint: <a href="/metrics/sales" class="text-primary underline">/metrics/sales</a></div>
  </div>
</div>

<!-- Gr√°ficos din√¢micos -->
<div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="chart-container bg-white rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold mb-2 text-primary">Receita por Per√≠odo <span title="Gr√°fico gerado com Chart.js mostrando a evolu√ß√£o da receita ao longo do tempo." style="cursor:help;">‚ÑπÔ∏è</span></h3>
    <canvas id="revenueChart" class="w-full h-64"></canvas>
  </div>
  <div class="chart-container bg-white rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold mb-2 text-primary">Distribui√ß√£o por Categoria <span title="Gr√°fico gerado com D3 mostrando a distribui√ß√£o das vendas por categoria de produto." style="cursor:help;">‚ÑπÔ∏è</span></h3>
    <div id="d3-category-chart" class="w-full h-64"></div>
  </div>
</div>

<!-- Tabela de Vendas -->
<div class="bg-card border border-border rounded-lg shadow overflow-hidden mb-8">
  <div class="p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-primary">Vendas<span title="Tabela mostra vendas recentes, permite busca e ordena√ß√£o." style="cursor:help;">‚ÑπÔ∏è</span></h2>
    </div>
    <p class="text-xs text-gray-600 mb-2">Tabela detalhada das vendas. Utilize os campos de busca e filtro para encontrar registros espec√≠ficos.</p>

    <!-- Filtros de colunas -->
    <div class="mb-4 grid grid-cols-6 gap-2">
      <input type="text" id="filter-order_id" placeholder="order_id" class="p-2 border rounded text-xs" />
      <input type="text" id="filter-region" placeholder="region" class="p-2 border rounded text-xs" />
      <input type="text" id="filter-product" placeholder="product" class="p-2 border rounded text-xs" />
      <input type="text" id="filter-quantity" placeholder="quantity" class="p-2 border rounded text-xs" />
      <input type="text" id="filter-unit_price" placeholder="unit_price" class="p-2 border rounded text-xs" />
      <input type="text" id="filter-total" placeholder="total" class="p-2 border rounded text-xs" />
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="sales-table">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID do Pedido</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regi√£o</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo Unit√°rio</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Cliente</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criado em</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Atualizado em</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observa√ß√µes</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Usu√°rio</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forma de Pagamento</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="sales-table-body">
          <!-- Preenchido dinamicamente via JS -->
        </tbody>
      </table>
    </div>
    
    <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4">
      <div class="flex flex-1 justify-between sm:hidden">
        <button class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" id="prev-page-mobile">Anterior</button>
        <button class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" id="next-page-mobile">Pr√≥ximo</button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Mostrando <span class="font-medium" id="start-item">1</span> a <span class="font-medium" id="end-item">10</span> de <span class="font-medium" id="total-items">{{ sales|length }}</span> resultados
          </p>
        </div>
        <div>
          <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <button class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" id="prev-page">
              <span class="sr-only">Anterior</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="pagination-numbers" class="flex">
              <!-- Pagination numbers will be inserted here by JavaScript -->
            </div>
            <button class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" id="next-page">
              <span class="sr-only">Pr√≥ximo</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Power BI -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Embed Power BI</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    {% if power_bi_url %}
      <iframe src="{{ power_bi_url }}" height="800" class="w-full rounded-lg border border-border transition-shadow duration-300 hover:shadow-lg"></iframe>
    {% else %}
      <div class="text-kpi">Power BI n√£o configurado.</div>
    {% endif %}
  </div>
</div>

<!-- Endpoints REST (GET/POST) -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Exemplos de API REST <span title="API REST exp√µe endpoints para acessar ou modificar dados via HTTP." style="cursor:help;">‚ÑπÔ∏è</span></h2>
  <p class="text-xs text-gray-600 mb-2">Consuma os endpoints GET diretamente no navegador. Para POST, utilize os exemplos curl no terminal para executar rotinas de ML, ETL e exporta√ß√£o.</p>
  <div class="bg-card rounded-lg p-4 mb-4">
    <div class="mb-2 text-sm text-gray-700">Endpoints <b>GET</b> funcionam direto no navegador. Endpoints <b>POST</b> devem ser chamados via <b>curl</b> ou <b>fetch</b> (bot√£o copiar dispon√≠vel).</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-bold text-primary mb-2">GET <span title="M√©todo GET retorna dados do servidor." style="cursor:help;">‚ÑπÔ∏è</span></h3>
        <ul class="list-disc pl-6 text-kpi">
          <li><a href="/health" class="text-primary underline">/health</a> ‚Äî Status da API e banco</li>
          <li><a href="/metrics/sales" class="text-primary underline">/metrics/sales</a> ‚Äî Preview de vendas</li>
          <li><a href="/metrics/summary" class="text-primary underline">/metrics/summary</a> ‚Äî KPIs agregados</li>
          <li><a href="/stats/pearson" class="text-primary underline">/stats/pearson</a> ‚Äî Correla√ß√£o Pearson</li>
          <li><a href="/stats/ols" class="text-primary underline">/stats/ols</a> ‚Äî Regress√£o OLS</li>
          <li><a href="/export/excel" class="text-primary underline">/export/excel</a> ‚Äî Exportar Excel</li>
        </ul>
      </div>
      <div>
        <h3 class="font-bold text-primary mb-2">POST <span title="M√©todo POST envia dados ou executa rotinas no servidor." style="cursor:help;">‚ÑπÔ∏è</span></h3>
        <ul class="list-disc pl-6 text-kpi">
          <li>Treinar modelo ML <span title="Machine Learning: algoritmos que aprendem padr√µes dos dados." style="cursor:help;">‚ÑπÔ∏è</span> <span class="text-xs text-gray-400">Exemplo: <code>curl -X POST /ml/train</code> <span title="curl √© um comando para fazer requisi√ß√µes HTTP pelo terminal." style="cursor:help;">‚ÑπÔ∏è</span></span></li>
          <li>Predi√ß√£o ML <span title="Predi√ß√£o: estimar valores com base em dados e modelos treinados." style="cursor:help;">‚ÑπÔ∏è</span> <span class="text-xs text-gray-400">Exemplo: <code>curl -X POST -H 'Content-Type: application/json' -d '{\"quantity\":10,\"unit_price\":200}' /ml/predict</code> <span title="curl √© um comando para fazer requisi√ß√µes HTTP pelo terminal." style="cursor:help;">‚ÑπÔ∏è</span></span></li>
          <li>Executar ETL Prefect <span title="ETL: Extrair, Transformar e Carregar dados. Prefect √© uma ferramenta de automa√ß√£o de ETL." style="cursor:help;">‚ÑπÔ∏è</span> <span class="text-xs text-gray-400">Exemplo: <code>curl -X POST /etl/run</code> <span title="curl √© um comando para fazer requisi√ß√µes HTTP pelo terminal." style="cursor:help;">‚ÑπÔ∏è</span></span></li>
          <li>Exportar Gold Parquet/CSV <span title="Parquet/CSV: formatos de arquivo para exporta√ß√£o de dados." style="cursor:help;">‚ÑπÔ∏è</span> <span class="text-xs text-gray-400">Exemplo: <code>curl -X POST /gold/export</code> <span title="curl √© um comando para fazer requisi√ß√µes HTTP pelo terminal." style="cursor:help;">‚ÑπÔ∏è</span></span></li>
          <li>Job PySpark <span title="PySpark: biblioteca para processamento distribu√≠do de dados em larga escala." style="cursor:help;">‚ÑπÔ∏è</span> <span class="text-xs text-gray-400">Exemplo: <code>curl -X POST /spark/run</code> <span title="curl √© um comando para fazer requisi√ß√µes HTTP pelo terminal." style="cursor:help;">‚ÑπÔ∏è</span></span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal para input de predi√ß√£o ML -->
<div id="predict-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:2rem;border-radius:8px;max-width:350px;margin:auto;">
    <h3 class="text-lg font-bold mb-2">Predi√ß√£o ML</h3>
    <label>Quantidade:</label>
    <input type="number" id="predict-quantity" class="w-full mb-2 p-2 border border-border rounded">
    <label>Pre√ßo unit√°rio:</label>
    <input type="number" id="predict-unit-price" class="w-full mb-4 p-2 border border-border rounded">
    <button id="predict-confirm" class="bg-primary text-white px-4 py-2 rounded">Executar</button>
    <button id="predict-cancel" class="ml-2 px-4 py-2 rounded border" onclick="document.getElementById('predict-modal').style.display='none'">Cancelar</button>
    <div id="predict-result" class="mt-4 text-sm"></div>
  </div>
</div>

<!-- Stack cards -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Infraestrutura & Data Stack</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üóÑÔ∏è</span><span class="font-bold">PostgreSQL</span></div>
      <div class="text-sm text-kpi">Tabela <code>sales</code>, trigger <code>set_total</code>, procedure <code>upsert_product_revenue</code>.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">‚ö°</span><span class="font-bold">ETL Prefect</span></div>
      <div class="text-sm text-kpi">Fluxo para gerar Parquet/CSV (camada Gold).</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üî•</span><span class="font-bold">PySpark</span></div>
      <div class="text-sm text-kpi">Job para processamento em larga escala.</div>
      <div class="text-xs text-red-600 mt-2">
        <b>Aten√ß√£o:</b> Para rodar jobs PySpark no Windows √© obrigat√≥rio ter <b>Java</b>, <b>HADOOP_HOME</b> e o arquivo <b>winutils.exe</b> em <code>C:\hadoop\bin</code>.<br>
        O suporte oficial do PySpark √© apenas para <b>Linux</b>. Em Windows, podem ocorrer erros de ambiente e permiss√µes.
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üìä</span><span class="font-bold">Export Excel</span></div>
      <div class="text-sm text-kpi">Endpoint usando OpenPyXL.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üß¨</span><span class="font-bold">dbt</span></div>
      <div class="text-sm text-kpi">Modelos <code>stg_sales</code> (silver) e <code>fct_sales</code> (gold) implementados no projeto.</div>
      <div class="mt-2 text-xs text-gray-700">Modelo <b>stg_sales.sql</b> (silver): Normaliza e garante coluna total.</div>
      <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">select
  order_id,
  region,
  product,
  quantity,
  unit_price,
  coalesce(total, quantity * unit_price) as total
from sales;</pre>
      <div class="mt-2 text-xs text-gray-700">Modelo <b>fct_sales.sql</b> (gold): Agrega receita e quantidade por produto.</div>
      <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">select
  product,
  sum(quantity)    as total_quantity,
  sum(total)       as total_revenue,
  avg(unit_price)  as avg_unit_price
from stg_sales
group by product;</pre>
      <div class="mt-2 text-xs text-gray-700">O dbt organiza dados em camadas: <b>Silver</b> (normaliza√ß√£o) e <b>Gold</b> (agrega√ß√£o anal√≠tica). Permite an√°lises confi√°veis e integra√ß√µes BI. <a href="https://docs.getdbt.com/docs/building-a-dbt-project" target="_blank" class="text-primary underline">Saiba mais</a></div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üê≥</span><span class="font-bold">Docker</span></div>
      <div class="text-sm text-kpi">Infraestrutura pronta para deploy local ou cloud.<br>
        <b>Dockerfile:</b>
        <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
RUN apt-get update && apt-get install -y \
    build-essential \
    openjdk-17-jre-headless \
    && rm -rf /var/lib/apt/lists/*
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="${JAVA_HOME}/bin:${PATH}"
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
COPY public ./public
EXPOSE 8000
CMD ["uvicorn", "app.backend.main:app", "--host", "0.0.0.0", "--port", "${PORT:-8000}"]
</pre>
        <b>docker-compose.yml:</b>
        <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">version: "3.9"
services:
  api:
    build: .
    container_name: moura_api
    ports:
      - "8000:8000"
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./public:/app/public
      - ./app:/app/app
      - ./sql:/app/sql
    restart: unless-stopped
</pre>
        <b>Exemplo:</b> <code>docker build -t moura-api .</code> <br>
        <code>docker run -p 8000:8000 moura-api</code> <br>
        <b>Compose:</b> <code>docker-compose up --build</code> <br>
        <a href="https://docs.docker.com/get-started/" target="_blank" class="text-primary underline">Documenta√ß√£o Docker</a>
      </div>
    </div>
  </div>
</div>

<!-- Machine Learning (Regress√£o Linear) -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Machine Learning ‚Äî Regress√£o Linear <span title="Regress√£o Linear: t√©cnica para prever valores com base em rela√ß√µes matem√°ticas." style="cursor:help;">‚ÑπÔ∏è</span><br><span class="text-xs text-gray-500 font-normal">Imagem gerada com <b>scikit-learn</b> para modelagem, <b>matplotlib</b> para visualiza√ß√£o e <b>pandas</b> para manipula√ß√£o dos dados.</span></h2>
  <p class="text-xs text-gray-600 mb-2">Este gr√°fico mostra a rela√ß√£o entre vari√°veis de vendas e o modelo de regress√£o linear treinado.</p>
  <img src="/public/ml_regression.png" alt="Regress√£o Linear" class="w-full h-64 object-contain" />
</div>

<!-- Big Data (PySpark) -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Big Data ‚Äî Receita Total por Produto (PySpark) <span title="PySpark: biblioteca para processamento distribu√≠do de dados em larga escala." style="cursor:help;">‚ÑπÔ∏è</span><br><span class="text-xs text-gray-500 font-normal">Imagem gerada com <b>PySpark</b> para processamento distribu√≠do e <b>matplotlib</b> para visualiza√ß√£o. <b>Java</b> √© obrigat√≥rio para execu√ß√£o do PySpark.</span></h2>
  <p class="text-xs text-gray-600 mb-2">Gr√°fico mostra a receita total agregada por produto, processada em larga escala com PySpark.</p>
  <img src="/public/pyspark_agg.png" alt="PySpark Aggregates" class="w-full h-64 object-contain" />
</div>

<!-- Gr√°ficos Interativos -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Plotly <span title="Plotly: biblioteca para gr√°ficos interativos em Python." style="cursor:help;">‚ÑπÔ∏è</span><br><span class="text-xs text-gray-500 font-normal">Imagem gerada com <b>plotly</b> para gr√°ficos interativos.</span></h2>
    <p class="text-xs text-gray-600 mb-2">Gr√°fico interativo para an√°lise visual din√¢mica dos dados de vendas.</p>
    <img src="/public/plotly.png" alt="Plotly Chart" class="w-full h-64 object-contain" />
  </div>
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Matplotlib <span title="Matplotlib: biblioteca para gr√°ficos est√°ticos em Python." style="cursor:help;">‚ÑπÔ∏è</span><br><span class="text-xs text-gray-500 font-normal">Imagem gerada com <b>matplotlib</b> para gr√°ficos est√°ticos.</span></h2>
    <p class="text-xs text-gray-600 mb-2">Gr√°fico est√°tico mostrando m√©tricas agregadas das vendas.</p>
    <img src="/public/matplotlib.png" alt="Matplotlib Chart" class="w-full h-64 object-contain" />
  </div>
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Seaborn <span title="Seaborn: biblioteca para gr√°ficos estat√≠sticos em Python." style="cursor:help;">‚ÑπÔ∏è</span><br><span class="text-xs text-gray-500 font-normal">Imagem gerada com <b>seaborn</b> para gr√°ficos estat√≠sticos.</span></h2>
    <p class="text-xs text-gray-600 mb-2">Gr√°fico estat√≠stico para an√°lise de correla√ß√µes e distribui√ß√µes dos dados.</p>
    <img src="/public/seaborn.png" alt="Seaborn Chart" class="w-full h-64 object-contain" />
  </div>
</div>

<!-- An√°lises Estat√≠sticas -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">An√°lises Estat√≠sticas <span title="An√°lises estat√≠sticas: t√©cnicas para entender padr√µes e rela√ß√µes nos dados." style="cursor:help;">‚ÑπÔ∏è</span><br><span class="text-xs text-gray-500 font-normal">Imagem gerada com <b>matplotlib</b>, <b>scipy</b> e <b>statsmodels</b> para an√°lises estat√≠sticas avan√ßadas.</span></h2>
  <p class="text-xs text-gray-600 mb-2">Gr√°fico apresenta resultados de testes estat√≠sticos e modelagens aplicadas aos dados de vendas.</p>
  <img src="/public/statistics.png" alt="An√°lises Estat√≠sticas" class="w-full h-64 object-contain" />
</div>

<!-- Scripts para gr√°ficos din√¢micos Chart.js, ApexCharts, Plotly e D3 -->
<script>
let currentPage = 1;
let totalRows = 0;
const pageSize = 20;
let columnFilters = {
  order_id: '',
  region: '',
  product: '',
  quantity: '',
  unit_price: '',
  total: ''
};
function getColumnFiltersQuery() {
  return Object.entries(columnFilters)
    .filter(([_, v]) => v)
    .map(([k, v]) => `filter_${k}=${encodeURIComponent(v)}`)
    .join('&');
}
function formatDateInput(dateStr) {
  // Aceita 'dd/mm/yyyy' ou 'yyyy-mm-dd' e retorna 'yyyy-mm-dd'
  if (!dateStr) return '';
  if (dateStr.includes('/')) {
    const [d, m, y] = dateStr.split('/');
    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }
  return dateStr;
}
async function fetchMetricsAndSales(page = 1) {
  const startDateRaw = document.getElementById('start-date').value;
  const endDateRaw = document.getElementById('end-date').value;
  const startDate = formatDateInput(startDateRaw);
  const endDate = formatDateInput(endDateRaw);
  const product = document.getElementById('product-filter').value;
  const offset = (page - 1) * pageSize;
  const filtersQuery = getColumnFiltersQuery();
  // KPIs
  const summaryRes = await fetch(`/metrics/summary?start_date=${startDate}&end_date=${endDate}&product=${product}`);
  const summary = await summaryRes.json();
  document.querySelector('#revenue-kpi .text-primary').textContent = `R$ ${Number(summary.total_revenue).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  document.querySelector('#quantity-kpi .text-primary').textContent = summary.total_quantity;
  document.querySelector('#avg-ticket-kpi .text-primary').textContent = `R$ ${Number(summary.avg_ticket).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  // Tabela de vendas
  let salesUrl = `/metrics/sales?start_date=${startDate}&end_date=${endDate}&product=${product}&limit=${pageSize}&offset=${offset}`;
  if (filtersQuery) salesUrl += `&${filtersQuery}`;
  const salesRes = await fetch(salesUrl);
  const salesData = await salesRes.json();
  totalRows = salesData.rows || 0;
  const tbody = document.getElementById('sales-table-body');
  tbody.innerHTML = '';
  if (!salesData.preview || salesData.preview.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="15" class="text-center text-gray-500 py-6">Nenhum dado encontrado para os filtros selecionados.</td>`;
    tbody.appendChild(tr);
  } else {
    salesData.preview.forEach(sale => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50';
      tr.innerHTML = `
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.order_id ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.region ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.product ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.quantity ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${sale.unit_price !== undefined ? Number(sale.unit_price).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${sale.total !== undefined ? Number(sale.total).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.date ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.customer_id ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.status ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.created_at ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.updated_at ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.notes ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.user_id ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.category ?? ''}</td>
        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-900">${sale.payment_method ?? ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  // Atualiza pagina√ß√£o
  const startItem = (offset + 1);
  const endItem = Math.min(offset + pageSize, totalRows);
  document.getElementById('start-item').textContent = startItem;
  document.getElementById('end-item').textContent = endItem;
  document.getElementById('total-items').textContent = totalRows;
  document.getElementById('prev-page').disabled = page <= 1;
  document.getElementById('next-page').disabled = endItem >= totalRows;
  document.getElementById('prev-page-mobile').disabled = page <= 1;
  document.getElementById('next-page-mobile').disabled = endItem >= totalRows;
  // Chart.js: Receita por Per√≠odo
  const revenueByDate = {};
  salesData.preview.forEach(sale => {
    // Garante que sale.date e sale.total existem
    if (sale.date && sale.total !== undefined && sale.total !== null) {
      if (!revenueByDate[sale.date]) revenueByDate[sale.date] = 0;
      revenueByDate[sale.date] += Number(sale.total);
    }
  });
  const revenueLabels = Object.keys(revenueByDate);
  const revenueValues = Object.values(revenueByDate);
  const revenueChartContainer = document.getElementById('revenueChart').parentElement;
  if (window.revenueChartInstance) window.revenueChartInstance.destroy();
  if (revenueLabels.length === 0) {
    revenueChartContainer.querySelector('canvas').style.display = 'none';
    if (!revenueChartContainer.querySelector('.no-data')) {
      const msg = document.createElement('div');
      msg.className = 'no-data text-center text-gray-500 py-6';
      msg.textContent = 'Nenhum dado para o gr√°fico de receita por per√≠odo.';
      revenueChartContainer.appendChild(msg);
    }
  } else {
    revenueChartContainer.querySelector('canvas').style.display = '';
    if (revenueChartContainer.querySelector('.no-data')) {
      revenueChartContainer.querySelector('.no-data').remove();
    }
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    window.revenueChartInstance = new Chart(revenueCtx, {
      type: 'line',
      data: {
        labels: revenueLabels,
        datasets: [{
          label: 'Receita',
          data: revenueValues,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
  // D3: Distribui√ß√£o por Categoria
  const categoryAgg = {};
  salesData.preview.forEach(sale => {
    // Garante que sale.product e sale.total existem
    if (sale.product && sale.total !== undefined && sale.total !== null) {
      if (!categoryAgg[sale.product]) categoryAgg[sale.product] = 0;
      categoryAgg[sale.product] += Number(sale.total);
    }
  });
  const d3Container = document.getElementById('d3-category-chart');
  d3Container.innerHTML = '';
  const data = Object.entries(categoryAgg).map(([product, total]) => ({product, total}));
  if (data.length === 0) {
    const msg = document.createElement('div');
    msg.className = 'no-data text-center text-gray-500 py-6';
    msg.textContent = 'Nenhum dado para o gr√°fico de distribui√ß√£o por categoria.';
    d3Container.appendChild(msg);
  } else {
    const width = d3Container.offsetWidth || 400;
    const height = 250;
    const svg = d3.select(d3Container).append('svg').attr('width', width).attr('height', height);
    const x = d3.scaleBand().domain(data.map(d => d.product)).range([40, width-20]).padding(0.2);
    const y = d3.scaleLinear().domain([0, d3.max(data, d => d.total)]).range([height-40, 20]);
    svg.append('g').attr('transform', `translate(0,${height-40})`).call(d3.axisBottom(x));
    svg.append('g').attr('transform', 'translate(40,0)').call(d3.axisLeft(y));
    svg.selectAll('.bar').data(data).enter().append('rect')
      .attr('class', 'bar')
      .attr('x', d => x(d.product))
      .attr('y', d => y(d.total))
      .attr('width', x.bandwidth())
      .attr('height', d => height-40 - y(d.total))
      .attr('fill', 'steelblue');
  }
}
function applyColumnFilters() {
  currentPage = 1;
  fetchMetricsAndSales(currentPage);
}
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('apply-filters').addEventListener('click', () => {
    currentPage = 1;
    fetchMetricsAndSales(currentPage);
  });
  document.getElementById('prev-page').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      fetchMetricsAndSales(currentPage);
    }
  });
  document.getElementById('next-page').addEventListener('click', () => {
    if ((currentPage * pageSize) < totalRows) {
      currentPage++;
      fetchMetricsAndSales(currentPage);
    }
  });
  document.getElementById('prev-page-mobile').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      fetchMetricsAndSales(currentPage);
    }
  });
  document.getElementById('next-page-mobile').addEventListener('click', () => {
    if ((currentPage * pageSize) < totalRows) {
      currentPage++;
      fetchMetricsAndSales(currentPage);
    }
  });
  // Filtros de coluna
  ['order_id','region','product','quantity','unit_price','total'].forEach(col => {
    document.getElementById(`filter-${col}`).addEventListener('input', e => {
      columnFilters[col] = e.target.value;
      applyColumnFilters();
    });
  });
  fetchMetricsAndSales(currentPage);
});
</script>
{% endblock %}
