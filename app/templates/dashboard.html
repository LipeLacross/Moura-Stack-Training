{% extends "base.html" %}
{% block title %}Dashboard Moura Stack{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock %}

{% block content %}
<link rel="icon" type="image/x-icon" href="/public/moura-logo.ico">

<!-- Guia r√°pido para o avaliador -->
<div class="mb-10 p-6 bg-card border border-border rounded-lg shadow flex flex-col md:flex-row gap-6 items-center">
  <div class="flex-1">
    <h2 class="text-2xl font-bold text-primary mb-2">Bem-vindo ao Moura Stack üöÄ</h2>
    <p class="text-kpi mb-2">Este dashboard demonstra um projeto completo de Data Stack para an√°lise de vendas, automa√ß√£o de ETL, machine learning, exporta√ß√£o de dados e integra√ß√£o com BI.</p>
    <ul class="list-disc pl-6 text-kpi text-sm mb-2">
      <li>KPIs e gr√°ficos interativos</li>
      <li>API REST com endpoints GET/POST</li>
      <li>ETL Prefect, PySpark, dbt, Export Excel</li>
      <li>Infraestrutura Docker pronta para produ√ß√£o</li>
    </ul>
    <a href="/docs" target="_blank" class="inline-block mt-2 px-4 py-2 bg-primary text-white rounded shadow hover:bg-blue-700 font-bold">Abrir documenta√ß√£o Swagger/OpenAPI</a>
  </div>
</div>

<!-- Filtros -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Filtros</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Data Inicial</label>
      <input type="date" id="start-date" class="w-full p-2 border border-border rounded">
    </div>
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Data Final</label>
      <input type="date" id="end-date" class="w-full p-2 border border-border rounded">
    </div>
    <div>
      <label class="block text-sm font-medium text-kpi mb-1">Produto</label>
      <select id="product-filter" class="w-full p-2 border border-border rounded">
        <option value="">Todos os Produtos</option>
        {% for product in products %}
        <option value="{{ product }}">{{ product }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex items-end">
      <button id="apply-filters" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-blue-700">
        Aplicar Filtros
      </button>
    </div>
  </div>
</div>

<!-- KPIs -->
<div class="mb-8">
  <h2 class="text-2xl font-bold mb-4 text-primary">Resumo de Vendas</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10" id="kpi-container">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center relative" id="revenue-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">üí∞</span>
        <span class="uppercase text-sm text-kpi">Receita Total</span>
      </div>
      <div class="text-2xl font-bold text-primary">R$ {{ summary.total_revenue | round(2) }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">‚Üí</span> <span class="trend-value">0%</span>
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center" id="quantity-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">üì¶</span>
        <span class="uppercase text-sm text-kpi">Quantidade Total</span>
      </div>
      <div class="text-2xl font-bold text-primary">{{ summary.total_quantity }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">‚Üí</span> <span class="trend-value">0%</span>
      </div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col items-center" id="avg-ticket-kpi">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-2xl">üé´</span>
        <span class="uppercase text-sm text-kpi">Ticket M√©dio</span>
      </div>
      <div class="text-2xl font-bold text-primary">R$ {{ summary.avg_ticket | round(2) }}</div>
      <div class="text-xs mt-1 text-green-500 flex items-center">
        <span class="trend-arrow">‚Üí</span> <span class="trend-value">0%</span>
      </div>
    </div>
  </div>
</div>

<!-- Preview de vendas -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Preview de Vendas (API)</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    <pre class="text-xs text-kpi" id="sales-preview"></pre>
    <div class="text-xs text-gray-400 mt-2">Endpoint: <a href="/metrics/sales" class="text-primary underline">/metrics/sales</a></div>
  </div>
</div>

<!-- Gr√°ficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-primary">Receita por Per√≠odo</h2>
      <div class="flex space-x-2">
        <button class="time-filter-btn px-3 py-1 rounded border border-border bg-white text-sm" data-period="week">Semana</button>
        <button class="time-filter-btn px-3 py-1 rounded border border-border bg-primary text-white text-sm" data-period="month">M√™s</button>
        <button class="time-filter-btn px-3 py-1 rounded border border-border bg-white text-sm" data-period="year">Ano</button>
      </div>
    </div>
    <div class="h-80">
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Distribui√ß√£o por Categoria</h2>
    <div class="h-80">
      <canvas id="categoryChart"></canvas>
    </div>
  </div>
</div>

<!-- Tabela de Vendas -->
<div class="bg-card border border-border rounded-lg shadow overflow-hidden mb-8">
  <div class="p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-primary">√öltimas Vendas</h2>
      <div class="relative">
        <input type="text" id="search-sales" placeholder="Buscar vendas..." class="pl-8 pr-4 py-2 border border-border rounded-lg">
        <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="sales-table">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="date">
              Data
              <span class="sort-indicator">‚Üì</span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="product">
              Produto
              <span class="sort-indicator"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="quantity">
              Quantidade
              <span class="sort-indicator"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="price">
              Pre√ßo Unit.
              <span class="sort-indicator"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="total">
              Total
              <span class="sort-indicator"></span>
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="sales-table-body">
          {% for sale in sales %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ sale.date }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ sale.product }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ sale.quantity }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {{ "%.2f"|format(sale.unit_price) }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">R$ {{ "%.2f"|format(sale.total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4">
      <div class="flex flex-1 justify-between sm:hidden">
        <button class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" id="prev-page-mobile">Anterior</button>
        <button class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" id="next-page-mobile">Pr√≥ximo</button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Mostrando <span class="font-medium" id="start-item">1</span> a <span class="font-medium" id="end-item">10</span> de <span class="font-medium" id="total-items">{{ sales|length }}</span> resultados
          </p>
        </div>
        <div>
          <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <button class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" id="prev-page">
              <span class="sr-only">Anterior</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="pagination-numbers" class="flex">
              <!-- Pagination numbers will be inserted here by JavaScript -->
            </div>
            <button class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" id="next-page">
              <span class="sr-only">Pr√≥ximo</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Power BI -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Embed Power BI</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    {% if power_bi_url %}
      <iframe src="{{ power_bi_url }}" height="800" class="w-full rounded-lg border border-border transition-shadow duration-300 hover:shadow-lg"></iframe>
    {% else %}
      <div class="text-kpi">Power BI n√£o configurado.</div>
    {% endif %}
  </div>
</div>

<!-- Endpoints REST (GET/POST) -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Exemplos de API REST</h2>
  <div class="bg-card rounded-lg p-4 mb-4">
    <div class="mb-2 text-sm text-gray-700">Endpoints <b>GET</b> funcionam direto no navegador. Endpoints <b>POST</b> devem ser chamados via <b>curl</b> ou <b>fetch</b> (bot√£o copiar dispon√≠vel).</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-bold text-primary mb-2">GET</h3>
        <ul class="list-disc pl-6 text-kpi">
          <li><a href="/health" class="text-primary underline">/health</a> ‚Äî Status da API e banco</li>
          <li><a href="/metrics/sales" class="text-primary underline">/metrics/sales</a> ‚Äî Preview de vendas</li>
          <li><a href="/metrics/summary" class="text-primary underline">/metrics/summary</a> ‚Äî KPIs agregados</li>
          <li><a href="/stats/pearson" class="text-primary underline">/stats/pearson</a> ‚Äî Correla√ß√£o Pearson</li>
          <li><a href="/stats/ols" class="text-primary underline">/stats/ols</a> ‚Äî Regress√£o OLS</li>
          <li><a href="/export/excel" class="text-primary underline">/export/excel</a> ‚Äî Exportar Excel</li>
        </ul>
      </div>
      <div>
        <h3 class="font-bold text-primary mb-2">POST</h3>
        <ul class="list-disc pl-6 text-kpi">
          <li>Treinar modelo ML <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /ml/train">Copiar curl</button>) <button class="exec-btn" data-endpoint="/ml/train">Executar</button></span></li>
          <li>Predi√ß√£o ML <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST -H 'Content-Type: application/json' -d '{\"quantity\":10,\"unit_price\":200}' /ml/predict">Copiar curl</button>) <button class="exec-btn" data-endpoint="/ml/predict" data-payload="true">Executar</button></span></li>
          <li>Executar ETL Prefect <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /etl/run">Copiar curl</button>) <button class="exec-btn" data-endpoint="/etl/run">Executar</button></span></li>
          <li>Exportar Gold Parquet/CSV <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /gold/export">Copiar curl</button>) <button class="exec-btn" data-endpoint="/gold/export">Executar</button></span></li>
          <li>Job PySpark <span class="text-xs text-gray-400">(<button class="copy-btn" data-cmd="curl -X POST /spark/run">Copiar curl</button>) <button class="exec-btn" data-endpoint="/spark/run">Executar</button></span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal para input de predi√ß√£o ML -->
<div id="predict-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:2rem;border-radius:8px;max-width:350px;margin:auto;">
    <h3 class="text-lg font-bold mb-2">Predi√ß√£o ML</h3>
    <label>Quantidade:</label>
    <input type="number" id="predict-quantity" class="w-full mb-2 p-2 border border-border rounded">
    <label>Pre√ßo unit√°rio:</label>
    <input type="number" id="predict-unit-price" class="w-full mb-4 p-2 border border-border rounded">
    <button id="predict-confirm" class="bg-primary text-white px-4 py-2 rounded">Executar</button>
    <button id="predict-cancel" class="ml-2 px-4 py-2 rounded border" onclick="document.getElementById('predict-modal').style.display='none'">Cancelar</button>
    <div id="predict-result" class="mt-4 text-sm"></div>
  </div>
</div>

<!-- Stack cards -->
<div class="mb-8">
  <h2 class="text-xl font-semibold mb-4 text-primary">Infraestrutura & Data Stack</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üóÑÔ∏è</span><span class="font-bold">PostgreSQL</span></div>
      <div class="text-sm text-kpi">Tabela <code>sales</code>, trigger <code>set_total</code>, procedure <code>upsert_product_revenue</code>.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">‚ö°</span><span class="font-bold">ETL Prefect</span></div>
      <div class="text-sm text-kpi">Fluxo para gerar Parquet/CSV (camada Gold).</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üî•</span><span class="font-bold">PySpark</span></div>
      <div class="text-sm text-kpi">Job para processamento em larga escala.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üìä</span><span class="font-bold">Export Excel</span></div>
      <div class="text-sm text-kpi">Endpoint usando OpenPyXL.</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üß¨</span><span class="font-bold">dbt</span></div>
      <div class="text-sm text-kpi">Modelos <code>stg_sales</code> (silver) e <code>fct_sales</code> (gold) implementados no projeto.</div>
      <div class="mt-2 text-xs text-gray-700">Modelo <b>stg_sales.sql</b> (silver): Normaliza e garante coluna total.</div>
      <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">select
  order_id,
  region,
  product,
  quantity,
  unit_price,
  coalesce(total, quantity * unit_price) as total
from sales;</pre>
      <div class="mt-2 text-xs text-gray-700">Modelo <b>fct_sales.sql</b> (gold): Agrega receita e quantidade por produto.</div>
      <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">select
  product,
  sum(quantity)    as total_quantity,
  sum(total)       as total_revenue,
  avg(unit_price)  as avg_unit_price
from stg_sales
group by product;</pre>
      <div class="mt-2 text-xs text-gray-700">O dbt organiza dados em camadas: <b>Silver</b> (normaliza√ß√£o) e <b>Gold</b> (agrega√ß√£o anal√≠tica). Permite an√°lises confi√°veis e integra√ß√µes BI. <a href="https://docs.getdbt.com/docs/building-a-dbt-project" target="_blank" class="text-primary underline">Saiba mais</a></div>
    </div>
    <div class="bg-card border border-border rounded-lg p-6 shadow flex flex-col gap-2">
      <div class="flex items-center gap-2"><span class="text-2xl">üê≥</span><span class="font-bold">Docker</span></div>
      <div class="text-sm text-kpi">Infraestrutura pronta para deploy local ou cloud.<br>
        <b>Dockerfile:</b>
        <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
RUN apt-get update && apt-get install -y \
    build-essential \
    openjdk-17-jre-headless \
    && rm -rf /var/lib/apt/lists/*
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="${JAVA_HOME}/bin:${PATH}"
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
COPY public ./public
EXPOSE 8000
CMD ["uvicorn", "app.backend.main:app", "--host", "0.0.0.0", "--port", "${PORT:-8000}"]
</pre>
        <b>docker-compose.yml:</b>
        <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">version: "3.9"
services:
  api:
    build: .
    container_name: moura_api
    ports:
      - "8000:8000"
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./public:/app/public
      - ./app:/app/app
      - ./sql:/app/sql
    restart: unless-stopped
</pre>
        <b>Exemplo:</b> <code>docker build -t moura-api .</code> <br>
        <code>docker run -p 8000:8000 moura-api</code> <br>
        <b>Compose:</b> <code>docker-compose up --build</code> <br>
        <a href="https://docs.docker.com/get-started/" target="_blank" class="text-primary underline">Documenta√ß√£o Docker</a>
      </div>
    </div>
  </div>
</div>

<!-- Machine Learning (Regress√£o Linear) -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Machine Learning ‚Äî Regress√£o Linear</h2>
  <div id="ml-results" class="text-sm text-kpi"></div>
</div>

<!-- Big Data (PySpark) -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">Big Data ‚Äî Receita Total por Produto (PySpark)</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200" id="spark-table">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receita Total</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="spark-table-body"></tbody>
    </table>
  </div>
</div>

<!-- Gr√°ficos Interativos -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Plotly</h2>
    <div id="plotly-chart"></div>
  </div>
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Matplotlib</h2>
    <img id="matplotlib-img" class="w-full h-64 object-contain" />
  </div>
  <div class="bg-card border border-border rounded-lg p-6 shadow">
    <h2 class="text-xl font-semibold mb-4 text-primary">Seaborn</h2>
    <img id="seaborn-img" class="w-full h-64 object-contain" />
  </div>
</div>

<!-- An√°lises Estat√≠sticas (Statsmodels) -->
<div class="mb-8 bg-card p-6 rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4 text-primary">An√°lises Estat√≠sticas</h2>
  <div id="pearson-result" class="mb-4 text-sm text-kpi"></div>
  <div id="ols-result" class="text-sm text-kpi"></div>
</div>
<script>
  // Pearson
  fetch('/stats/pearson').then(r => r.json()).then(data => {
    document.getElementById('pearson-result').innerHTML = `
      <b>Correla√ß√£o Pearson:</b> ${data.correlation.toFixed(3)}<br>
      <b>p-valor:</b> ${data.p_value.toExponential(2)}<br>
      <b>Vari√°veis:</b> ${data.x_name} √ó ${data.y_name}
    `;
  });
  // OLS
  fetch('/stats/ols').then(r => r.json()).then(data => {
    document.getElementById('ols-result').innerHTML = `
      <b>Regress√£o OLS:</b><br>
      <b>Coeficiente:</b> ${data.coef.toFixed(2)}<br>
      <b>Intercepto:</b> ${data.intercept.toFixed(2)}<br>
      <b>R¬≤:</b> ${data.r2.toFixed(3)}<br>
      <b>p-valor:</b> ${data.p_value.toExponential(2)}
    `;
  });
</script>

<script>
  // Fun√ß√£o para copiar curl para clipboard
  function copyToClipboard(cmd) {
    navigator.clipboard.writeText(cmd);
    alert('Comando copiado!');
  }
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      copyToClipboard(this.dataset.cmd);
    });
  });
  // Filtros, pesquisa e gr√°ficos
  async function fetchSales(filters = {}) {
    const params = new URLSearchParams(filters).toString();
    const res = await fetch(`/api/sales?${params}`);
    return await res.json();
  }
  function renderTable(sales) {
    const tbody = document.getElementById('sales-table-body');
    tbody.innerHTML = '';
    sales.forEach(sale => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${sale.date}</td><td>${sale.product}</td><td>${sale.quantity}</td><td>R$ ${sale.unit_price.toFixed(2)}</td><td>R$ ${sale.total.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('apply-filters').onclick = async function() {
    const start = document.getElementById('start-date').value;
    const end = document.getElementById('end-date').value;
    const product = document.getElementById('product-filter').value;
    const data = await fetchSales({start_date: start, end_date: end, product});
    renderTable(data.sales);
    renderCharts(data.sales);
  };
  document.getElementById('search-sales').oninput = async function(e) {
    const q = e.target.value.toLowerCase();
    const data = await fetchSales();
    const filtered = data.sales.filter(sale => sale.product.toLowerCase().includes(q));
    renderTable(filtered);
  };
  function renderCharts(sales) {
    // Receita por per√≠odo
    const ctx1 = document.getElementById('revenueChart').getContext('2d');
    const revenueData = {};
    sales.forEach(sale => {
      const d = sale.date;
      revenueData[d] = (revenueData[d] || 0) + sale.total;
    });
    new Chart(ctx1, {
      type: 'line',
      data: {
        labels: Object.keys(revenueData),
        datasets: [{label: 'Receita', data: Object.values(revenueData), borderColor: '#2563eb'}]
      }
    });
    // Distribui√ß√£o por categoria
    const ctx2 = document.getElementById('categoryChart').getContext('2d');
    const catData = {};
    sales.forEach(sale => {
      catData[sale.product] = (catData[sale.product] || 0) + sale.total;
    });
    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: Object.keys(catData),
        datasets: [{label: 'Receita', data: Object.values(catData), backgroundColor: ['#2563eb','#22d3ee','#f59e42','#f43f5e','#a3e635']}]
      }
    });
  }
  async function renderAllCharts() {
    // Chart.js
    const salesRes = await fetch('/api/sales');
    const salesData = await salesRes.json();
    const ctx = document.getElementById('chartjsChart').getContext('2d');
    const chartjs = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: salesData.sales.map(s => s.product),
        datasets: [{label: 'Receita', data: salesData.sales.map(s => s.total), backgroundColor: '#2563eb'}]
      }
    });
    // Plotly.js
    const plotlyRes = await fetch('/extras/plotly-sales');
    const plotlyJson = await plotlyRes.json();
    Plotly.newPlot('plotlyChart', plotlyJson.data, plotlyJson.layout);
    // Matplotlib
    const mplRes = await fetch('/extras/matplotlib-sales');
    const mplJson = await mplRes.json();
    document.getElementById('matplotlibChart').src = mplJson.image;
    // Seaborn
    const sbRes = await fetch('/extras/seaborn-sales');
    const sbJson = await sbRes.json();
    document.getElementById('seabornChart').src = sbJson.image;
    // D3.js
    const svg = d3.select('#d3Chart');
    svg.selectAll('*').remove();
    const margin = {top: 20, right: 20, bottom: 30, left: 40}, width = 400 - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    const x = d3.scaleBand().range([0, width]).padding(0.1);
    const y = d3.scaleLinear().range([height, 0]);
    x.domain(salesData.sales.map(s => s.product));
    y.domain([0, d3.max(salesData.sales, s => s.total)]);
    g.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x));
    g.append('g').call(d3.axisLeft(y));
    g.selectAll('.bar').data(salesData.sales).enter().append('rect')
      .attr('class', 'bar')
      .attr('x', d => x(d.product))
      .attr('y', d => y(d.total))
      .attr('width', x.bandwidth())
      .attr('height', d => height - y(d.total))
      .attr('fill', '#22d3ee');
  }
  window.onload = async function() {
    const data = await fetchSales();
    renderTable(data.sales);
    renderCharts(data.sales);
    await renderAllCharts();
  };
  function showToast(msg, success=true) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '30px';
    toast.style.right = '30px';
    toast.style.background = success ? '#2563eb' : '#f43f5e';
    toast.style.color = '#fff';
    toast.style.padding = '12px 24px';
    toast.style.borderRadius = '8px';
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }
  document.querySelectorAll('.exec-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const endpoint = this.dataset.endpoint;
      if (this.dataset.payload) {
        // Abrir modal para input
        document.getElementById('predict-modal').style.display = 'flex';
        document.getElementById('predict-result').textContent = '';
        document.getElementById('predict-confirm').onclick = async function() {
          const quantity = document.getElementById('predict-quantity').value;
          const unit_price = document.getElementById('predict-unit-price').value;
          try {
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({quantity: Number(quantity), unit_price: Number(unit_price)})
            });
            const data = await res.json();
            document.getElementById('predict-result').textContent = 'Predi√ß√£o: ' + (data.y_pred ?? JSON.stringify(data));
            showToast('Predi√ß√£o realizada!', true);
          } catch (e) {
            document.getElementById('predict-result').textContent = 'Erro: ' + e;
            showToast('Erro na predi√ß√£o!', false);
          }
        };
      } else {
        try {
          const res = await fetch(endpoint, {method: 'POST'});
          const data = await res.json();
          showToast('Executado com sucesso: ' + JSON.stringify(data), true);
        } catch (e) {
          showToast('Erro: ' + e, false);
        }
      }
    });
  });
  // Machine Learning
  fetch('/ml/linear-regression').then(r => r.json()).then(data => {
    document.getElementById('ml-results').innerHTML = `
      <b>Coeficiente:</b> ${data.coef.toFixed(2)}<br>
      <b>Intercepto:</b> ${data.intercept.toFixed(2)}<br>
      <b>Score (R¬≤):</b> ${(data.score*100).toFixed(2)}%<br>
      <b>Previs√£o para quantidade m√©dia (${data.mean_quantity.toFixed(2)}):</b> R$ ${data.predicted_total.toFixed(2)}
    `;
  });
  // Big Data
  fetch('/bigdata/spark-aggregates').then r => r.json()).then(rows => {
    const tbody = document.getElementById('spark-table-body');
    tbody.innerHTML = rows.map(row => `<tr><td class='px-6 py-4'>${row.product}</td><td class='px-6 py-4'>R$ ${parseFloat(row.total_revenue).toFixed(2)}</td></tr>`).join('');
  });
  // Plotly
  fetch('/plotly-sales').then(r => r.json()).then(fig => {
    Plotly.newPlot('plotly-chart', fig.data, fig.layout);
  });
  // Matplotlib
  fetch('/matplotlib-sales').then(r => r.json()).then(data => {
    document.getElementById('matplotlib-img').src = data.image;
  });
  // Seaborn
  fetch('/seaborn-sales').then(r => r.json()).then(data => {
    document.getElementById('seaborn-img').src = data.image;
  });
</script>
{% endblock %}
